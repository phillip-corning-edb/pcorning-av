---
- name: Update postgres directory ownership
  file:
    path: /opt/postgres
    state: directory
    owner: postgres
    group: postgres
    recurse: yes

- name: Update postgres log directory ownership
  file:
    path: /var/log/postgres
    state: directory
    owner: postgres
    group: postgres
    recurse: yes

- name: Rebuild SRC dirs and run postgres installcheck (ignore all errors)
  block:
    # POSTGRES
    - name: postgres configure
      shell: "./configure --prefix=/opt/postgres/13 --enable-tap-tests --enable-debug --with-openssl --config-cache CFLAGS=-O0"
      args:
        chdir: "/opt/postgres/src/postgres"
    - name: postgres run make
      make:
        chdir: "/opt/postgres/src/postgres"
        params:
          NUM_THREADS: 2
    - name: postgres install
      make:
        chdir: "/opt/postgres/src/postgres"
        target: install

    # PGLOGICAL
    - name: pglogical clean
      make:
        chdir: "/opt/postgres/src/pglogical"
        target: clean
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config
    - name: pglogical make
      make:
        chdir: "/opt/postgres/src/pglogical"
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config
          NUM_THREADS: 2
    - name: pglogical install
      make:
        chdir: "/opt/postgres/src/pglogical"
        target: install
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config

    # BDR
    - name: bdr clean
      make:
        chdir: "/opt/postgres/src/bdr"
        target: clean
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config
    - name: bdr make
      make:
        chdir: "/opt/postgres/src/bdr"
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config
          NUM_THREADS: 2
    - name: bdr install
      make:
        chdir: "/opt/postgres/src/bdr"
        target: install
        params:
          PG_CONFIG: /opt/postgres/13/bin/pg_config

    # RESTART POSTGRES
    - include_role: name=postgres/restart
      vars:
        postgres_service_end_state: started

    # POSTGRES INSTALL CHECK
    - name: postgres run installcheck (creates regression database)
      make:
        chdir: "/opt/postgres/src/postgres"
        target: installcheck

  become: yes
  become_user: postgres
  ignore_errors: yes


- name: HOOK redirect root login to postgres
  blockinfile:
    path: /root/.bashrc
    create: yes
    block: |
      sudo su - postgres
    state: present


#TODO: Set GIT REPO KEYS, GIT identity, re-clone repos? (before rebuild?), use "rescue" above to prevent need for configure/clean?


